<%- include('partials/header') %>

<div class="container mt-3 mt-md-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-body p-3 p-sm-4 p-md-5">
                    <h2 class="card-title text-center mb-4">Complete Your Profile</h2>
                    <p class="text-center text-muted mb-4">
                        Enter your address to find and join your neighborhood community
                    </p>

                    <% if (typeof messages !== 'undefined' && messages) { %>
                        <% if (messages.error) { %>
                            <div class="alert alert-danger" role="alert">
                                <%= messages.error %>
                            </div>
                        <% } %>
                    <% } %>

                    <form action="/signup/complete-profile" method="POST" id="addressForm">
                        <div class="mb-4">
                            <label for="address" class="form-label">Your Address</label>
                            <input
                                type="text"
                                class="form-control form-control-lg"
                                id="address"
                                name="address"
                                placeholder="123 Main St, Your City, Province"
                                required
                                autocomplete="off"
                            >
                            <input type="hidden" id="placeId" name="placeId">
                            <div class="form-text">
                                Start typing your address and select from the suggestions
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                Join My Neighborhood
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Places API -->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= process.env.GOOGLE_PLACES_API_KEY %>&libraries=places"></script>
<script>
    let autocomplete;
    let placeSelected = false;

    function initAutocomplete() {
        const input = document.getElementById('address');
        const submitBtn = document.getElementById('submitBtn');

        autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['address'],
            componentRestrictions: { country: ['ca', 'us'] }
        });

        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();

            if (!place.place_id) {
                placeSelected = false;
                submitBtn.disabled = true;
                return;
            }

            document.getElementById('placeId').value = place.place_id;
            placeSelected = true;
            submitBtn.disabled = false;
        });

        input.addEventListener('input', function() {
            if (placeSelected) {
                placeSelected = false;
                submitBtn.disabled = true;
                document.getElementById('placeId').value = '';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initAutocomplete);
</script>

<%- include('partials/footer') %>
