<%- include('partials/header') %>
<%- include('partials/nav') %>

<div class="container-fluid mt-4">
    <!-- Search Bar -->
    <div class="neighbours-search-container" style="max-width: 1400px; margin: 0 auto 1.5rem auto; padding: 0 1rem;">
        <div class="search-input-wrapper-neighbours">
            <i class="bi bi-search search-icon-neighbours"></i>
            <input
                type="text"
                id="neighbourSearch"
                class="form-control search-input-neighbours"
                placeholder="Search neighbours by name..."
                autocomplete="off"
            >
            <button type="button" class="btn-clear-search" id="clearSearch" style="display: none;">
                <i class="bi bi-x-circle-fill"></i>
            </button>
        </div>
    </div>

    <!-- Map and Neighbours Container -->
    <div class="neighbours-container">
        <!-- Map (Top on mobile, Right on desktop) -->
        <div class="map-container">
            <!-- Online Count Header -->
            <div class="map-header">
                <i class="bi bi-circle-fill text-success" style="font-size: 0.5rem;"></i>
                <span id="neighbourCount"><%= onlineCount %></span> <%= onlineCount === 1 ? 'neighbor' : 'neighbors' %> online
            </div>
            <div id="neighboursMap" class="neighbours-map"></div>
        </div>

        <!-- Neighbours List (Left on desktop, Bottom on mobile) -->
        <div class="neighbours-list-container">
            <div class="row g-3">
                <% if (neighbours.length === 0) { %>
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center py-5">
                                <i class="bi bi-moon-stars text-muted" style="font-size: 4rem;"></i>
                                <h4 class="mt-3 mb-2">No neighbors online right now</h4>
                                <p class="text-muted mb-3">
                                    Check back later or be the first to post!
                                </p>
                                <a href="/neighborhood" class="btn btn-primary">
                                    <i class="bi bi-chat-dots"></i> Go to Feed
                                </a>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <% neighbours.forEach(function(neighbour, index) {
                        // Extract street name from address (remove house number)
                        let streetName = '';
                        if (neighbour.address && neighbour.address.formatted) {
                            const addressParts = neighbour.address.formatted.split(',');
                            if (addressParts.length > 0) {
                                // Get first part and remove leading numbers
                                const firstPart = addressParts[0].trim();
                                streetName = firstPart.replace(/^\d+\s*/, '');
                            }
                        }
                    %>
                        <div class="col-12 col-md-6 col-xl-4">
                            <div class="card h-100 neighbour-card" data-neighbour-index="<%= index %>">
                                <div class="card-body p-3">
                                    <div class="text-center mb-3">
                                        <img
                                            src="<%= neighbour.avatar %>"
                                            alt="<%= neighbour.displayName %>"
                                            class="rounded-circle mb-2"
                                            width="80"
                                            height="80"
                                        >
                                        <h5 class="mb-1"><%= neighbour.displayName %></h5>
                                        <% if (neighbour._id.toString() === user._id.toString()) { %>
                                            <span class="badge bg-primary mb-2">You</span>
                                        <% } %>
                                    </div>
                                    <div class="neighbour-info">
                                        <% if (streetName && neighbour.settings?.showAddress !== false) { %>
                                            <p class="mb-2">
                                                <i class="bi bi-geo-alt-fill text-primary"></i>
                                                <small class="text-muted"><%= streetName %></small>
                                            </p>
                                        <% } %>
                                        <p class="mb-0">
                                            <i class="bi bi-calendar-check text-success"></i>
                                            <small class="text-muted">
                                                Joined <%= new Date(neighbour.createdAt).toLocaleDateString('en-US', {
                                                    month: 'long',
                                                    year: 'numeric'
                                                }) %>
                                            </small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } %>
            </div>

            <!-- Back to Feed -->
            <div class="text-center mt-4 mb-4">
                <a href="/neighborhood" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Back to Feed
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps Script -->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= process.env.GOOGLE_PLACES_API_KEY %>&libraries=places,geometry"></script>

<script>
// Neighbours data for map - ONLY show online users on the map
const fiveMinutesAgo = <%= fiveMinutesAgo %>;
const neighboursData = [
    <% neighbours.forEach(function(neighbour, index) { %>
        <%
        // Check if neighbour is online
        const isOnline = neighbour.lastActive &&
                        new Date(neighbour.lastActive).getTime() >= fiveMinutesAgo &&
                        neighbour.settings?.showOnlineStatus === true;
        %>
        <% if (neighbour.address && neighbour.address.lat && neighbour.address.lng && isOnline) { %>
        {
            name: '<%= neighbour.displayName %>',
            avatar: '<%= neighbour.avatar %>',
            lat: <%= neighbour.address.lat %>,
            lng: <%= neighbour.address.lng %>,
            isCurrentUser: <%= neighbour._id.toString() === user._id.toString() %>
        }<%= index < neighbours.length - 1 ? ',' : '' %>
        <% } %>
    <% }) %>
].filter(n => n); // Remove any empty entries

let map;
let markers = [];
let neighborhoodBoundary;
let neighborhoodCenter;

function initMap() {
    if (neighboursData.length === 0) return;

    // Calculate center of all neighbours
    const bounds = new google.maps.LatLngBounds();
    let totalLat = 0;
    let totalLng = 0;

    neighboursData.forEach(neighbour => {
        bounds.extend(new google.maps.LatLng(neighbour.lat, neighbour.lng));
        totalLat += neighbour.lat;
        totalLng += neighbour.lng;
    });

    // Calculate neighborhood center from average of all neighbors
    neighborhoodCenter = {
        lat: totalLat / neighboursData.length,
        lng: totalLng / neighboursData.length
    };

    console.log('Neighborhood center:', neighborhoodCenter);
    console.log('Total neighbors:', neighboursData.length);

    // Initialize map with grayscale (black & white) style
    map = new google.maps.Map(document.getElementById('neighboursMap'), {
        center: bounds.getCenter(),
        zoom: 15,
        maxZoom: 15,
        styles: [
            {
                "elementType": "geometry",
                "stylers": [{ "color": "#f5f5f5" }]
            },
            {
                "elementType": "labels.icon",
                "stylers": [{ "visibility": "off" }]
            },
            {
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#616161" }]
            },
            {
                "elementType": "labels.text.stroke",
                "stylers": [{ "color": "#f5f5f5" }]
            },
            {
                "featureType": "administrative.land_parcel",
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#bdbdbd" }]
            },
            {
                "featureType": "poi",
                "elementType": "geometry",
                "stylers": [{ "color": "#eeeeee" }]
            },
            {
                "featureType": "poi",
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#757575" }]
            },
            {
                "featureType": "poi.park",
                "elementType": "geometry",
                "stylers": [{ "color": "#e5e5e5" }]
            },
            {
                "featureType": "poi.park",
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#9e9e9e" }]
            },
            {
                "featureType": "road",
                "elementType": "geometry",
                "stylers": [{ "color": "#ffffff" }]
            },
            {
                "featureType": "road.arterial",
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#757575" }]
            },
            {
                "featureType": "road.highway",
                "elementType": "geometry",
                "stylers": [{ "color": "#dadada" }]
            },
            {
                "featureType": "road.highway",
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#616161" }]
            },
            {
                "featureType": "road.local",
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#9e9e9e" }]
            },
            {
                "featureType": "transit.line",
                "elementType": "geometry",
                "stylers": [{ "color": "#e5e5e5" }]
            },
            {
                "featureType": "transit.station",
                "elementType": "geometry",
                "stylers": [{ "color": "#eeeeee" }]
            },
            {
                "featureType": "water",
                "elementType": "geometry",
                "stylers": [{ "color": "#c9c9c9" }]
            },
            {
                "featureType": "water",
                "elementType": "labels.text.fill",
                "stylers": [{ "color": "#9e9e9e" }]
            },
            {
                "featureType": "poi.business",
                "stylers": [{ "visibility": "off" }]
            }
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: true,
        zoomControlOptions: {
            position: google.maps.ControlPosition.RIGHT_TOP
        },
        gestureHandling: 'greedy',
        backgroundColor: '#f5f5f5'
    });

    // Fit bounds with padding
    map.fitBounds(bounds, { top: 60, right: 60, bottom: 60, left: 60 });

    // Draw neighborhood boundary after a short delay to ensure map is ready
    setTimeout(() => {
        try {
            // Calculate neighborhood boundary radius
            let maxDistance = 0;
            neighboursData.forEach(neighbour => {
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(neighborhoodCenter.lat, neighborhoodCenter.lng),
                    new google.maps.LatLng(neighbour.lat, neighbour.lng)
                );
                if (distance > maxDistance) {
                    maxDistance = distance;
                }
            });

            // Add 50% padding to the radius, with a minimum of 800 meters
            let boundaryRadius = Math.max(maxDistance * 1.5, 800);

            console.log('Drawing boundary circle:', {
                center: neighborhoodCenter,
                radius: boundaryRadius,
                maxDistance: maxDistance
            });

            // Draw neighborhood boundary circle
            neighborhoodBoundary = new google.maps.Circle({
                strokeColor: '#DC3545',
                strokeOpacity: 1,
                strokeWeight: 5,
                fillColor: '#DC3545',
                fillOpacity: 0.15,
                map: map,
                center: new google.maps.LatLng(neighborhoodCenter.lat, neighborhoodCenter.lng),
                radius: boundaryRadius,
                clickable: false,
                zIndex: 0,
                editable: false
            });

            console.log('Boundary circle created successfully!');
        } catch (error) {
            console.error('Error creating boundary circle:', error);
        }
    }, 500);

    // Add markers for each neighbour
    console.log('Total neighbours to render:', neighboursData.length);
    const usedPositions = [];

    neighboursData.forEach((neighbour, index) => {
        console.log(`Processing neighbour ${index}:`, neighbour.name, `at (${neighbour.lat}, ${neighbour.lng})`);
        let lat = neighbour.lat;
        let lng = neighbour.lng;

        // Check if this exact position is already used
        const positionKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        const existingPosition = usedPositions.find(p => p.key === positionKey);

        if (existingPosition) {
            // Position already used - add offset so dots are clearly visible
            const offsetMeters = 50; // 50 meters apart
            const offsetDegrees = offsetMeters / 111320; // Convert meters to degrees
            const angle = (existingPosition.count * (Math.PI * 2 / 8)); // Spread in circle
            lat = lat + (offsetDegrees * Math.cos(angle));
            lng = lng + (offsetDegrees * Math.sin(angle));
            existingPosition.count++;
            console.log(`Offsetting marker ${index} by ${offsetMeters}m at angle ${angle}`);
        } else {
            usedPositions.push({ key: positionKey, count: 1 });
        }

        // Create SVG dot marker (larger for current user)
        const dotSize = neighbour.isCurrentUser ? 16 : 12;
        const dotColor = neighbour.isCurrentUser ? '#3b82f6' : '#22c55e'; // Blue for you, green for others

        const svgMarker = {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: dotColor,
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: dotSize / 2,
        };

        const marker = new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: map,
            title: neighbour.name,
            icon: svgMarker,
            animation: google.maps.Animation.DROP,
            zIndex: neighbour.isCurrentUser ? 1000 : index,
            optimized: false
        });

        console.log(`âœ“ Created marker for ${neighbour.name} at (${lat}, ${lng}) - Color: ${dotColor}`);

        // Add info window with profile card styling
        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div class="neighbour-info-window">
                    <div style="text-align: center; padding: 8px;">
                        <img src="${neighbour.avatar}" alt="${neighbour.name}"
                             style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${neighbour.name}</div>
                        ${neighbour.isCurrentUser ? '<span style="background: #0c0c18; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; display: inline-block;">You</span>' : ''}
                    </div>
                </div>
            `,
            disableAutoPan: true,
            pixelOffset: new google.maps.Size(0, -10)
        });

        // Show on hover (mouseover)
        marker.addListener('mouseover', () => {
            // Close all other info windows
            markers.forEach(m => m.infoWindow.close());
            infoWindow.open(map, marker);
        });

        // Close on mouseout
        marker.addListener('mouseout', () => {
            setTimeout(() => {
                infoWindow.close();
            }, 300); // Small delay to allow moving to the info window
        });

        // Also show on click
        marker.addListener('click', () => {
            // Close all other info windows
            markers.forEach(m => m.infoWindow.close());
            infoWindow.open(map, marker);
        });

        markers.push({ marker, infoWindow });
    });
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', initMap);

// Handle card hover to highlight marker
document.querySelectorAll('.neighbour-card').forEach((card, index) => {
    card.addEventListener('mouseenter', () => {
        if (markers[index]) {
            markers[index].marker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => {
                markers[index].marker.setAnimation(null);
            }, 700);
        }
    });
});

// Search functionality
const searchInput = document.getElementById('neighbourSearch');
const clearSearchBtn = document.getElementById('clearSearch');
const neighbourCards = document.querySelectorAll('.neighbour-card');
const neighbourCountEl = document.getElementById('neighbourCount');

function filterNeighbours(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    let visibleCount = 0;

    neighbourCards.forEach((card, index) => {
        const neighbourName = card.querySelector('h5').textContent.toLowerCase();
        const isMatch = neighbourName.includes(term);

        if (isMatch) {
            card.closest('.col-12').style.display = '';
            visibleCount++;
            // Show marker on map
            if (markers[index]) {
                markers[index].marker.setVisible(true);
            }
        } else {
            card.closest('.col-12').style.display = 'none';
            // Hide marker on map
            if (markers[index]) {
                markers[index].marker.setVisible(false);
            }
        }
    });

    // Update count
    neighbourCountEl.textContent = visibleCount;

    // Show/hide clear button
    if (term.length > 0) {
        clearSearchBtn.style.display = 'block';
    } else {
        clearSearchBtn.style.display = 'none';
    }

    // Adjust map bounds to show only visible markers
    if (visibleCount > 0 && map) {
        const visibleBounds = new google.maps.LatLngBounds();
        markers.forEach((m, index) => {
            if (m.marker.getVisible()) {
                visibleBounds.extend(m.marker.getPosition());
            }
        });
        // Include the boundary circle in the bounds
        if (neighborhoodBoundary) {
            visibleBounds.extend(new google.maps.LatLng(
                neighborhoodCenter.lat + (neighborhoodBoundary.getRadius() / 111320),
                neighborhoodCenter.lng
            ));
            visibleBounds.extend(new google.maps.LatLng(
                neighborhoodCenter.lat - (neighborhoodBoundary.getRadius() / 111320),
                neighborhoodCenter.lng
            ));
        }
        map.fitBounds(visibleBounds, { top: 60, right: 60, bottom: 60, left: 60 });
    }
}

// Search input event listener
searchInput.addEventListener('input', (e) => {
    filterNeighbours(e.target.value);
});

// Clear search button
clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    filterNeighbours('');
    searchInput.focus();
});

// Allow Enter key to trigger search
searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        searchInput.value = '';
        filterNeighbours('');
        searchInput.blur();
    }
});
</script>

<%- include('partials/footer') %>
