<%- include('partials/header') %>
<%- include('partials/nav') %>

<div class="container mt-3 mt-md-4">
    <div class="row">
        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
            <!-- Search Header -->
            <div class="card mb-3 mb-md-4">
                <div class="card-body p-3 p-sm-4">
                    <h2 class="card-title mb-3">
                        <i class="bi bi-search"></i>
                        Search Results
                    </h2>
                    <form action="/neighborhood/search" method="GET">
                        <div class="search-input-wrapper-large">
                            <i class="bi bi-search search-icon-large"></i>
                            <input
                                type="text"
                                name="q"
                                class="form-control search-input-large"
                                placeholder="Search posts in <%= neighborhood.name %>..."
                                value="<%= query %>"
                                autofocus
                            >
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>
                    </form>
                    <% if (query) { %>
                        <p class="text-muted mt-3 mb-0">
                            <% if (posts.length > 0) { %>
                                Found <%= posts.length %> <%= posts.length === 1 ? 'result' : 'results' %> for "<strong><%= query %></strong>"
                            <% } else { %>
                                No results found for "<strong><%= query %></strong>"
                            <% } %>
                        </p>
                    <% } %>
                </div>
            </div>

            <!-- Search Results -->
            <% if (query && posts.length === 0) { %>
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">No posts found</h4>
                        <p class="text-muted">Try different keywords or check your spelling</p>
                        <a href="/neighborhood" class="btn btn-primary mt-2">
                            <i class="bi bi-arrow-left"></i> Back to Feed
                        </a>
                    </div>
                </div>
            <% } else if (!query) { %>
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">Search Your Neighborhood</h4>
                        <p class="text-muted">Enter keywords to search through posts in <%= neighborhood.name %></p>
                    </div>
                </div>
            <% } else { %>
                <!-- Posts Feed -->
                <% posts.forEach(function(post) { %>
                    <div class="card mb-3 post-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img src="<%= post.userId.avatar %>" alt="<%= post.userId.displayName %>" class="rounded-circle me-3" width="50" height="50">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0"><%= post.userId.displayName %></h6>
                                    <small class="text-muted">
                                        <%= new Date(post.createdAt).toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric',
                                            year: 'numeric',
                                            hour: 'numeric',
                                            minute: '2-digit'
                                        }) %>
                                    </small>
                                </div>
                                <% if (post.userId._id.toString() === user._id.toString()) { %>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <form action="/posts/<%= post._id %>/delete" method="POST">
                                                    <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this post?')">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                <% } %>
                            </div>

                            <p class="card-text"><%= post.text %></p>

                            <% if (post.imageUrl) { %>
                                <img src="<%= post.imageUrl %>" alt="Post image" class="img-fluid rounded mt-2" style="max-height: 500px; width: 100%; object-fit: cover;">
                            <% } %>

                            <!-- Comment Count -->
                            <div class="border-top mt-3 pt-3">
                                <% if (post.commentCount > 0) { %>
                                    <button
                                        class="btn btn-link text-decoration-none text-muted p-0 mb-2 w-100 text-start comment-toggle-btn"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#comments-<%= post._id %>"
                                        aria-expanded="false"
                                    >
                                        <i class="bi bi-chat-left-text"></i>
                                        <span class="comment-count-text">
                                            <%= post.commentCount %> <%= post.commentCount === 1 ? 'comment' : 'comments' %>
                                        </span>
                                        <i class="bi bi-chevron-down float-end toggle-icon"></i>
                                    </button>
                                <% } else { %>
                                    <div class="text-muted mb-2">
                                        <i class="bi bi-chat-left-text"></i>
                                        No comments yet
                                    </div>
                                <% } %>

                                <!-- Comments Section (Collapsible) -->
                                <% if (post.comments && post.comments.length > 0) { %>
                                    <div class="collapse comments-section mb-3" id="comments-<%= post._id %>">
                                        <% post.comments.forEach(function(comment) { %>
                                            <div class="comment-item d-flex mb-2">
                                                <img src="<%= comment.userId.avatar %>" alt="<%= comment.userId.displayName %>" class="rounded-circle me-2" width="32" height="32">
                                                <div class="flex-grow-1">
                                                    <div class="comment-bubble bg-light p-2 rounded">
                                                        <strong class="d-block" style="font-size: 0.9rem;"><%= comment.userId.displayName %></strong>
                                                        <p class="mb-0" style="font-size: 0.9rem;"><%= comment.text %></p>
                                                    </div>
                                                </div>
                                            </div>
                                        <% }) %>
                                    </div>
                                <% } %>

                                <!-- Add Comment Form -->
                                <form action="/comments/create" method="POST" class="add-comment-form">
                                    <input type="hidden" name="postId" value="<%= post._id %>">
                                    <div class="d-flex align-items-start">
                                        <img src="<%= user.avatar %>" alt="<%= user.displayName %>" class="rounded-circle me-2" width="32" height="32">
                                        <div class="flex-grow-1">
                                            <input
                                                type="text"
                                                name="text"
                                                class="form-control form-control-sm"
                                                placeholder="Write a comment..."
                                                maxlength="500"
                                                required
                                            >
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm ms-2">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                <% }) %>

                <!-- Back to Feed -->
                <div class="text-center mt-4 mb-4">
                    <a href="/neighborhood" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Back to Feed
                    </a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
