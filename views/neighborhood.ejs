<%- include('partials/header') %>
<%- include('partials/nav') %>

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Neighborhood Header -->
            <div class="card mb-4 bg-primary text-white">
                <div class="card-body">
                    <h2 class="card-title mb-2">
                        <i class="bi bi-house-heart-fill"></i>
                        <%= neighborhood.name %> Community
                    </h2>
                    <p class="mb-0">
                        <i class="bi bi-geo-alt"></i>
                        <%= neighborhood.city %>, <%= neighborhood.province %>
                        <span class="ms-3">
                            <i class="bi bi-people"></i>
                            <%= neighborhood.memberCount %> <%= neighborhood.memberCount === 1 ? 'neighbour' : 'neighbours' %>
                        </span>
                    </p>
                </div>
            </div>

            <!-- Create Post Card -->
            <div class="card mb-4">
                <form action="/posts/create" method="POST" enctype="multipart/form-data" id="createPostForm">
                    <div class="card-body p-2 p-sm-3">
                        <div class="d-flex align-items-start gap-2 mb-2">
                            <img src="<%= user.avatar %>" alt="<%= user.displayName %>" class="rounded-circle flex-shrink-0" width="40" height="40">
                            <div class="flex-grow-1">
                                <textarea
                                    name="text"
                                    class="form-control border-0 resize-none"
                                    rows="1"
                                    maxlength="2000"
                                    placeholder="What's on your mind, <%= user.displayName.split(' ')[0] %>?"
                                    id="postTextarea"
                                    style="overflow: hidden;"
                                    required
                                ></textarea>
                                <div class="text-end">
                                    <small class="text-muted"><span id="charCount">0</span>/2000</small>
                                </div>
                            </div>
                        </div>

                        <!-- Image Preview -->
                        <div id="imagePreviewContainer" class="mt-2 mb-2" style="display: none;">
                            <div class="position-relative d-inline-block">
                                <img id="imagePreview" src="" class="img-fluid rounded" style="max-height: 300px;">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" id="removeImageBtn">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>

                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-1">
                                <label for="imageUpload" class="btn btn-light btn-sm post-action-btn-inline">
                                    <i class="bi bi-image text-success"></i>
                                    <span class="d-none d-sm-inline ms-1">Photo</span>
                                </label>
                                <input type="file" name="image" id="imageUpload" accept="image/*" class="d-none">
                            </div>
                            <button type="submit" class="btn btn-primary" id="postSubmitBtn" disabled>
                                Post
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Posts Feed -->
            <% if (posts.length === 0) { %>
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-chat-left-dots text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">No posts yet</h4>
                        <p class="text-muted">Be the first to share something with your neighborhood!</p>
                        <a href="/posts/new" class="btn btn-primary mt-2">Create First Post</a>
                    </div>
                </div>
            <% } else { %>
                <% posts.forEach(function(post) { %>
                    <div class="card mb-3 post-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img src="<%= post.userId.avatar %>" alt="<%= post.userId.displayName %>" class="rounded-circle me-3" width="40" height="40">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0"><%= post.userId.displayName %></h6>
                                    <small class="text-muted post-timestamp" data-timestamp="<%= new Date(post.createdAt).getTime() %>">
                                        <%= new Date(post.createdAt).toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric',
                                            year: 'numeric',
                                            hour: 'numeric',
                                            minute: '2-digit'
                                        }) %>
                                    </small>
                                </div>
                                <% if (post.userId._id.toString() === user._id.toString()) { %>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <form action="/posts/<%= post._id %>/delete" method="POST">
                                                    <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this post?')">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                <% } %>
                            </div>

                            <p class="card-text"><%= post.text %></p>

                            <% if (post.imageUrl) { %>
                                <img src="<%= post.imageUrl %>" alt="Post image" class="img-fluid rounded mt-2" style="max-height: 500px; width: 100%; object-fit: cover;">
                            <% } %>

                            <!-- Post Footer: Report Button -->
                            <% if (post.userId._id.toString() !== user._id.toString()) { %>
                                <div class="post-footer d-flex align-items-center justify-content-end mt-3 pt-2 border-top">
                                    <button class="btn btn-sm btn-link text-danger concern-btn p-0"
                                            data-post-id="<%= post._id %>"
                                            title="Report this post for review"
                                            style="font-size: 0.875rem; text-decoration: none;">
                                        <i class="bi bi-flag-fill"></i> Report Post
                                    </button>
                                </div>
                            <% } %>

                            <!-- Comment Count -->
                            <div class="mt-3 pt-3">
                                <% if (post.commentCount > 0) { %>
                                    <button
                                        class="btn btn-link text-decoration-none text-muted mb-2 w-100 text-start comment-toggle-btn"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#comments-<%= post._id %>"
                                        aria-expanded="false"
                                        style="padding: 8px 16px;"
                                    >
                                        <i class="bi bi-chat-left-text"></i>
                                        <span class="comment-count-text">
                                            <%= post.commentCount %> <%= post.commentCount === 1 ? 'comment' : 'comments' %>
                                        </span>
                                        <i class="bi bi-chevron-down toggle-icon" style="float: right;"></i>
                                    </button>
                                <% } else { %>
                                    <div class="text-muted mb-2" style="padding: 8px 16px;">
                                        <i class="bi bi-chat-left-text"></i>
                                        No comments yet
                                    </div>
                                <% } %>

                                <!-- Comments Section (Collapsible) -->
                                <% if (post.comments && post.comments.length > 0) { %>
                                    <div class="collapse comments-section mb-3 px-3" id="comments-<%= post._id %>">
                                        <% post.comments.forEach(function(comment) { %>
                                            <div class="comment-item d-flex mb-2">
                                                <img src="<%= comment.userId.avatar %>" alt="<%= comment.userId.displayName %>" class="rounded-circle me-2" width="32" height="32">
                                                <div class="flex-grow-1">
                                                    <div class="comment-bubble bg-light p-2 rounded">
                                                        <strong class="d-block" style="font-size: 0.9rem;"><%= comment.userId.displayName %></strong>
                                                        <p class="mb-0" style="font-size: 0.9rem;"><%= comment.text %></p>
                                                    </div>
                                                    <div class="d-flex align-items-center mt-1">
                                                        <small class="text-muted post-timestamp" style="font-size: 0.75rem;" data-timestamp="<%= new Date(comment.createdAt).getTime() %>">
                                                            <%= new Date(comment.createdAt).toLocaleDateString('en-US', {
                                                                month: 'short',
                                                                day: 'numeric',
                                                                hour: 'numeric',
                                                                minute: '2-digit'
                                                            }) %>
                                                        </small>
                                                        <% if (comment.userId._id.toString() === user._id.toString()) { %>
                                                            <form action="/comments/<%= comment._id %>/delete" method="POST" class="d-inline ms-2">
                                                                <button type="submit" class="btn btn-link btn-sm text-danger p-0" style="font-size: 0.75rem; text-decoration: none;" onclick="return confirm('Delete this comment?')">
                                                                    Delete
                                                                </button>
                                                            </form>
                                                        <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% }) %>

                                        <% if (post.commentCount > 3) { %>
                                            <div class="text-center mb-2">
                                                <button class="btn btn-sm btn-link text-muted" onclick="loadAllComments('<%= post._id %>')">
                                                    View all <%= post.commentCount %> comments
                                                </button>
                                            </div>
                                        <% } %>
                                    </div>
                                <% } %>

                                <!-- Add Comment Form -->
                                <form action="/comments/create" method="POST" class="add-comment-form px-3">
                                    <input type="hidden" name="postId" value="<%= post._id %>">
                                    <div class="d-flex align-items-start">
                                        <img src="<%= user.avatar %>" alt="<%= user.displayName %>" class="rounded-circle me-2" width="32" height="32">
                                        <div class="flex-grow-1">
                                            <input
                                                type="text"
                                                name="text"
                                                class="form-control form-control-sm"
                                                placeholder="Write a comment..."
                                                maxlength="500"
                                                required
                                            >
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm ms-2">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                <% }) %>
            <% } %>
        </div>
    </div>
</div>

<!-- Report Post Modal -->
<div class="modal fade" id="concernModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Report This Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">
                    Help keep our neighborhood community safe and spam-free. Your report will be reviewed by our AI system.
                </p>

                <form id="concernForm">
                    <input type="hidden" id="concernPostId">

                    <div class="mb-3">
                        <label class="form-label fw-semibold">What's wrong with this post?</label>
                        <select class="form-select" name="reason" required>
                            <option value="">Select a reason...</option>
                            <option value="promotional">üè¢ Promotional/Business Advertising</option>
                            <option value="spam">üìß Spam or Repetitive Content</option>
                            <option value="hate_speech">üö´ Hate Speech or Offensive Language</option>
                            <option value="harassment">‚ö†Ô∏è Harassment or Bullying</option>
                            <option value="inappropriate">‚ùå Inappropriate Content</option>
                            <option value="other">üí≠ Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Additional context (optional)</label>
                        <textarea
                            class="form-control"
                            name="details"
                            rows="3"
                            placeholder="Help us understand why this post is problematic..."></textarea>
                        <small class="text-muted">
                            Your feedback helps our AI learn and improve moderation.
                        </small>
                    </div>

                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle"></i>
                        When 3+ neighbors report a post, our AI will re-review it with your feedback.
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-flag-fill"></i> Report Post
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<%- include('partials/footer') %>
